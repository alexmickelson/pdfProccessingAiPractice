@page "/"
@rendermode InteractiveServer
@using System.IO
@using ImageMagick

<PageTitle>PDF Viewer</PageTitle>

<h1>PDF Upload and View</h1>

<div class="upload-section">
  <InputFile OnChange="@LoadFile" accept=".pdf" />
</div>

@if (_imageUrls != null && _imageUrls.Any())
{
  <div class="pdf-viewer" style="position: relative;">
    @foreach (var box in boxes)
    {
      <div style="
        position: absolute;
        left:@(box.xTop)px;
        top:@(box.yTop)px;
        width:@(box.xBot - box.xTop)px;
        height:@(box.yBot - box.yTop)px;
        border: 2px solid red;
      ">
      </div>
    }
    @foreach (var imageUrl in _imageUrls)
    {
      <img src="@imageUrl" class="pdf-image" />
    }
  </div>
}

@code {
  private List<string>? _imageUrls;
  private List<(int xTop, int yTop, int xBot, int yBot)> boxes = [(50, 50, 100, 100)];

  private async Task LoadFile(InputFileChangeEventArgs e)
  {
    var file = e.File;
    if (file != null)
    {
      var memoryStream = new MemoryStream();
      await file.OpenReadStream(maxAllowedSize: 10485760).CopyToAsync(memoryStream);
      memoryStream.Position = 0;

      _imageUrls = new List<string>();

      // Convert PDF to PNG
      using (var images = new MagickImageCollection())
      {
        // Read all pages of the PDF
        images.Read(memoryStream, new MagickReadSettings
        {
          Format = MagickFormat.Pdf,
          Density = new Density(300, 300) // Set DPI for good quality
        });

        // Convert each page to PNG
        foreach (var image in images)
        {
          var imageStream = new MemoryStream();
          image.Write(imageStream, MagickFormat.Png);
          var base64Data = Convert.ToBase64String(imageStream.ToArray());
          _imageUrls.Add($"data:image/png;base64,{base64Data}");
        }
      }
    }
  }
}

<style>
  .upload-section {
    margin: 20px 0;
  }

  .pdf-viewer {
    margin: 20px 0;
  }

  .pdf-image {
    width: 100%;
    display: block;
    margin-bottom: 20px;
    border: 1px solid #ccc;
    border-radius: 4px;
  }
</style>
